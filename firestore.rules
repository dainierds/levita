rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funciones de Ayuda ---

    // Verifica si el usuario está autenticado
    function isSignedIn() {
      return request.auth != null;
    }

    // Obtiene los datos del usuario actual desde la colección 'users'
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Verifica si es Super Admin
    function isSuperAdmin() {
      return isSignedIn() && getUserData().role == 'SUPER_ADMIN';
    }

    // Verifica si el usuario pertenece al Tenant (Iglesia) del documento que intenta acceder
    function belongsToTenant(resourceTenantId) {
      return isSignedIn() && (getUserData().tenantId == resourceTenantId || isSuperAdmin());
    }

    // Verifica si es Admin de su iglesia
    function isAdmin() {
      return isSignedIn() && getUserData().role == 'ADMIN';
    }

    // 1. Colección de Usuarios (Perfiles)
    match /users/{userId} {
      allow read: if true;
      allow write: if (
        // Allow creating MUSIC users without auth (PIN verified on client)
        (resource == null && request.resource.data.role == 'MUSIC')
      ) || (
        isSignedIn() && (
          request.auth.uid == userId || 
          isSuperAdmin() ||
          (isAdmin() && (
            (resource == null && request.resource.data.tenantId == getUserData().tenantId) ||
            (resource != null && resource.data.tenantId == getUserData().tenantId)
          ))
        )
      );
    }

    // ... (tenants rules unchanged) ...

    // 4. Invitaciones
    match /invitations/{invitationId} {
      allow read: if true;
      allow create: if isSignedIn();
      
      // Allow update if signed in OR if only marking as USED (for unauthenticated joins)
      allow update: if isSignedIn() || (
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']) &&
        request.resource.data.status == 'USED'
      );

      // Allow delete if signed in
      allow delete: if isSignedIn();
    }

    // 2. Colección de Tenants (Iglesias)
    match /tenants/{tenantId} {
      // Cualquiera autenticado puede leer la info básica de su iglesia (para config, nombre, etc)
      allow read: if true;
      
      // Super Admin puede todo. Admin puede editar SU propia iglesia.
      allow write: if isSignedIn() && (
        isSuperAdmin() ||
        (isAdmin() && tenantId == getUserData().tenantId)
      );

      // Chat en Vivo (Visitors + Members)
      match /live_messages/{messageId} {
        allow read, create: if true;
      }
      
      // Live Transcription (Audio Dashboard -> Visitor App)
      match /live/{document=**} {
        allow read: if true;
        allow write: if isSignedIn(); // HOTFIX: Relaxed from belongsToTenant(tenantId) to fix write error
      }

      // Music Teams (New)
      match /music_teams/{teamId} {
        allow read: if true;
        allow write: if isSignedIn();
      }

      // Events (Subcollection)
      match /events/{eventId} {
        allow read: if true;
        allow write: if belongsToTenant(tenantId);
      }

      // Plans (Subcollection)
      match /plans/{planId} {
        allow read: if true;
        allow write: if belongsToTenant(tenantId);
      }
    }

    // 3. Colecciones de Datos de la Iglesia (Eventos, Canciones, etc.)
    
    // Configuración Pública de la Iglesia
    match /churchSettings/{settingId} {
      allow read: if true;
      allow write: if belongsToTenant(resource.data.tenantId) || isAdmin(); // Maintain write security
    }

    match /events/{eventId} {
      // Allow public read for visitor view
      allow read: if true;
      allow create: if belongsToTenant(request.resource.data.tenantId);
      allow update, delete: if belongsToTenant(resource.data.tenantId);
    }

    // Corrected to servicePlans to match Admin application code
    match /servicePlans/{planId} {
      // Allow public read for visitor view
      allow read: if true;
      allow create: if belongsToTenant(request.resource.data.tenantId);
      allow update, delete: if belongsToTenant(resource.data.tenantId);
    }
    
    match /songs/{songId} {
      allow read: if belongsToTenant(resource.data.tenantId);
      allow create: if belongsToTenant(request.resource.data.tenantId);
      allow update, delete: if belongsToTenant(resource.data.tenantId);
    }

    // 4. Invitaciones
    match /invitations/{invitationId} {
      // Permitir leer públicamente para validar el código en /join
      allow read: if true;
      
      // Permitir crear solo a usuarios autenticados (Admins)
      allow create: if isSignedIn();
      
      // Permitir actualizar (marcar como usada) y eliminar a usuarios autenticados
      allow update, delete: if isSignedIn();
    }

    // 5. Prayer Requests (Peticiones de Oración)
    match /prayerRequests/{requestId} {
      // Allow visitors to create prayer requests without auth
      allow create: if true; 
      
      // Only authenticated users (admins/staff) related to the tenant can read/manage them
      allow read, update, delete: if belongsToTenant(resource.data.tenantId);
    }

    // 6. Notifications (Used by Visitor App too)
    match /notifications/{notificationId} {
        allow read: if true; // Public retrieval
        allow create: if belongsToTenant(request.resource.data.tenantId);
        allow update: if true; // Allow visitors to mark as read (arrayUnion)
        allow delete: if belongsToTenant(resource.data.tenantId);
    }

    // Regla por defecto: Bloquear todo lo demás por seguridad
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
